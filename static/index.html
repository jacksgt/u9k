<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="Create a short, typeable link from a long URL">
    <title>U9K - Link Shortener</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/favicon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/static/icons/favicon.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/static/icons/favicon.ico">
    <link rel="stylesheet" href="/static/css/pure-min.css">
    <link rel="stylesheet" href="/static/css/grids-responsive-min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>

<div class="header">
    <div class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed">
      <a href="/" title="U9K Homepage">
        <img src="/static/icons/favicon-180x180.png" alt="U9K Logo" style="height: 3em; vertical-align: middle;">
      </a>

        <ul class="pure-menu-list">
            <!-- <li class="pure-menu-item pure-menu-selected"><a href="#" class="pure-menu-link">Home</a></li> -->
            <!-- <li class="pure-menu-item"><a href="#" class="pure-menu-link">Tour</a></li> -->
            <!-- <li class="pure-menu-item"><a href="#" class="pure-menu-link">Sign Up</a></li> -->
        </ul>
    </div>
</div>

<div class="content-wrapper">

  <div class="content">
        <h2 class="is-center">Shorten a Link</h2>

        <div class="pure-g">

          <form class="pure-form pure-u-1" id="link-form">
            <fieldset>
              <div class="mandatory-form-part">
                <legend name="legend">Paste your URL and hit Enter!</legend>
                <div data-tip="Copied to Clipboard!">
                  <input type="url" name="url" class="pure-input-1" placeholder="https://..." required="true"/>
                </div>
              </div>
              <div class="optional-form-part">
                Optionally, choose a custom short link:
                <label for="link" style="display: flex;">
                  <span style="margin: auto;">https://u9k.de/</span>
                  <input style="width: 100%;" type="text" name="link" placeholder="e.g. awesome-food" title="Only letters of the alphabet (a-z, A-Z), digits (0-9) as well as '-' and '_'; at least 6 characters" pattern="[a-zA-Z0-9-_]{6,}">
                </label>
                <div style="text-align:center;">
                  <input type="submit" name="submit" class="pure-button pure-button-primary" value="Do it!">
                </div>
              </div>
              <div class="form-qr-code">
              </div>
            </fieldset>
          </form>

          <div id="link-list-wrapper" class="pure-u-1">

            These are your most recent links (<a id="button-clear-link-list">clear</a>):
            <span title="This list of links is stored inside your browser only (localStorage), not on our servers. You can delete the link list by clicking 'clear'. This does not delete links from our servers.">
              <a>
              <svg style="display: inline; height: 1.5em; width: 1.5em; float: right;">
                <use href="#question-mark-circle"></use>
              </svg>
              </a>
            </span>

            <table id="link-list-table" class="pure-table pure-table-striped">
              <thead>
                <tr>
                  <th>Link</th>
                  <th>URL</th>
                  <th>Creation Date</th>
                </tr>
              </thead>
              <tbody>
                <!-- <tr> -->
                  <!--   <td>Shortlink</td> -->
                  <!--   <td>URL</td> -->
                  <!--   <td>Create Date</td> -->
                  <!-- </tr> -->
              </tbody>
            </table>
          </div>
        </div>

  </div>

  <div style="height: 50px;"><!-- make some space for the footer, so it doesnt overlap --></div>

  <div class="footer l-box is-center">
    u9k.de is developed and hosted by <a href="https://blog.cubieserver.de/">Jack Henschel</a>.
  </div>

</div>
<svg width="0" height="0" class="hidden">
  <symbol id="question-mark-circle" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
  </symbol>
</svg>
</body>
<script src="/static/js/qrcode.min.js" async="true"></script>
<script>
  function selectAndCopy(element) {
      element.select(); // select (highlight) text
      document.execCommand('copy'); // copy to clipboard
      const tooltip = element.parentElement;
      tooltip.classList.toggle("show"); // show tooltip
      setTimeout(function(){ // hide tooltip after 5 seconds
          tooltip.classList.toggle("show");
      }, 5000);
  }

  function showQrCode(element, data) {
      if (! element) {
          console.log("showQrCode: Element is not defined. Skipping.")
          return
      }
      if (! window.QRCode) {
          console.log("showQrCode: QRCode library not found. Skipping.")
          return
      }

      var qrcode = new QRCode(element, {
	      text: data,
	      // width: 128,
	      // height: 128,
	      // colorDark : "#000000",
	      // colorLight : "#ffffff",
	      // correctLevel : QRCode.CorrectLevel.H
      });

      setTimeout(function(){ // small delay until QR code is ready
          element.style.display = "block";
      }, 100);
  }

  function localSaveLink(link) {
      if (! window.localStorage) {
          console.log("localSaveLink: Browser doesn't support localStorage. Skipping.");
          return []
      }

      let linkList;

      try {
          linkList = JSON.parse(localStorage.getItem("linkList") || '[]');
          linkList.push(link);
          localStorage.setItem("linkList", JSON.stringify(linkList));
      } catch(e) {
          console.log("localSaveLink:", e);
      }
      return linkList;
  }

  function localGetLinks() {
      if (! window.localStorage) {
          console.log("localGetLinks: Browser doesn't support localStorage. Skipping.");
          return []
      }

      try {
          let linkList = JSON.parse(localStorage.getItem("linkList") || '[]');
          return linkList;
      } catch(e) {
          console.log("localGetLinks:", e);
          return []
      }
  }

  function clearLinkList() {
      const tableBody = document.querySelector('#link-list-table tbody');
      /* iteratively remove all HTML elements from table (this method also unregisters any event handlers) */
      while (tableBody.firstChild) {
          tableBody.removeChild(tableBody.firstChild);
      }
      /* clear localStorage entry */
      if (window.localStorage) {
          localStorage.removeItem('linkList');
      }
  }

  function populateLinkList() {
      /* register handler for deleting list */
      document.querySelector("#button-clear-link-list").addEventListener('click', (event) => {
          clearLinkList();
      })

      const tableWrapper = document.querySelector("#link-list-wrapper");
      const tableBody = tableWrapper.querySelector("tbody");
      const linkList = localGetLinks();
      /* iterate over the list in reverse-chronological order,
       so the most recent item is at the top */
      for (let i = linkList.length-1; i >= 0; i--) {
          const l = linkList[i];
          let child = document.createElement('tr');
          // TODO: sanitize the treatment of these JSON fields
          child.innerHTML = `
              <td><a href="${l.link}" target="_blank">${l.link.split('://')[1]}</a></td>
              <td><a href="${l.url}" target="_blank">${l.url}</a></td>
              <td>${l.createTs.split('T')[0]}</td>
          `;
          tableBody.append(child);
      }
      if (linkList.length > 0) {
          tableWrapper.style.display = "block";
      }
  }

  function registerLinkFormHandler() {
      const linkForm = document.querySelector('#link-form');
      linkForm.addEventListener('submit', (event) => {
          // disable default action
          event.preventDefault();

          // configure a request
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/link/');

          // prepare form data
          let data = new FormData(linkForm);

          // set headers
          // xhr.setRequestHeader('Content-Type', 'multipart/form-data');

          // set up event handlers
          xhr.addEventListener("progress", () => {});
          xhr.addEventListener("load", () => {
              console.log(xhr.responseText);
              if (xhr.readyState == 4) {
                  switch (xhr.status) {
                  case 200:
                      const obj = JSON.parse(xhr.responseText);
                      const link = obj.link;
                      // change button style and text
                      linkForm.querySelector("legend").innerHTML = "Your link is now available under the following URL:"
                      var button = linkForm.submit;
                      button.classList.add('pure-button-ok');
                      button.value = "Done!";
                      // update with new URL
                      const field = linkForm.url;
                      field.value = link;
                      field.readOnly = true;
                      selectAndCopy(field);
                      // hide optional form part (input and submit)
                      linkForm.querySelector(".optional-form-part").style.display = "none";
                      showQrCode(linkForm.querySelector(".form-qr-code"), link)
                      // save in local storage
                      localSaveLink(obj);
                      break;

                  default:
                      console.log("ERROR:", xhr);
                      // change button style and text
                      var button = linkForm.submit;
                      button.classList.add('pure-button-warning');
                      button.value = "Try again ...";
                      linkForm.querySelector("legend").innerHTML = xhr.responseText;
                      break;
                  }
              }
          });
          xhr.addEventListener("error", () => {
              console.log("ERROR:", xhr);
              // change button style and text
              const button = linkForm.submit;
              button.classList.add('pure-button-orange');
              button.value = "Oops, there was an error!";
          });

          // send request
          xhr.send(data);
      });
  }

  window.addEventListener('load', (event) => {
      registerLinkFormHandler();
      populateLinkList();
  });
</script>
</html>
